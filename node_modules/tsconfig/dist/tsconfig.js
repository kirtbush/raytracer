var fs = require('fs');
var path = require('path');
var glob = require('glob');
var extend = require('xtend');
var stripBom = require('strip-bom');
var parseJson = require('parse-json');
exports.DEFAULTS = {
    target: 'es5',
    module: 'commonjs',
    declaration: false,
    noImplicitAny: false,
    removeComments: true
};
var CONFIG_FILENAME = 'tsconfig.json';
function resolve(dir, cb) {
    var configFile = path.resolve(dir, CONFIG_FILENAME);
    fileExists(configFile, function (err, exists) {
        if (err) {
            return cb(err);
        }
        if (exists) {
            return cb(null, configFile);
        }
        var parentDir = path.dirname(dir);
        if (dir === parentDir) {
            return cb(null, undefined);
        }
        return resolve(parentDir, cb);
    });
}
exports.resolve = resolve;
function resolveSync(dir) {
    var configFile = path.resolve(dir, CONFIG_FILENAME);
    if (fileExistsSync(configFile)) {
        return configFile;
    }
    var parentDir = path.dirname(dir);
    if (dir === parentDir) {
        return;
    }
    return resolveSync(parentDir);
}
exports.resolveSync = resolveSync;
function load(dir, cb) {
    return resolve(dir, function (err, filename) {
        if (err) {
            return cb(err);
        }
        if (!filename) {
            return cb(new Error('No config file found'));
        }
        return readFile(filename, cb);
    });
}
exports.load = load;
function loadSync(dir) {
    var filename = resolveSync(dir);
    if (!filename) {
        throw new Error('No config file found');
    }
    return readFileSync(filename);
}
exports.loadSync = loadSync;
function readFile(filename, cb) {
    fs.readFile(filename, 'utf8', function (err, contents) {
        if (err) {
            return cb(err);
        }
        return parseFile(stripBom(contents), filename, cb);
    });
}
exports.readFile = readFile;
function readFileSync(filename) {
    var contents = fs.readFileSync(filename, 'utf8');
    return parseFileSync(stripBom(contents), filename);
}
exports.readFileSync = readFileSync;
function parseFile(contents, filename, cb) {
    var data;
    try {
        data = parseJson(contents, null, filename);
    }
    catch (err) {
        cb(err);
        return;
    }
    resolveConfig(data, filename, cb);
}
exports.parseFile = parseFile;
function parseFileSync(contents, filename) {
    var data = parseJson(contents, null, filename);
    return resolveConfigSync(data, filename);
}
exports.parseFileSync = parseFileSync;
function resolveConfig(data, filename, cb) {
    var _a = getGlob(data), filesGlob = _a[0], ignore = _a[1];
    if (filesGlob) {
        return glob(filesGlob, {
            cwd: path.dirname(filename),
            nodir: true,
            ignore: ignore
        }, function (err, files) {
            if (err) {
                return cb(err);
            }
            return cb(null, sanitizeConfig(data, files, filename));
        });
    }
    process.nextTick(function () { return cb(null, sanitizeConfig(data, null, filename)); });
}
exports.resolveConfig = resolveConfig;
function resolveConfigSync(data, filename) {
    var _a = getGlob(data), filesGlob = _a[0], ignore = _a[1];
    if (filesGlob) {
        return sanitizeConfig(data, glob.sync(filesGlob, {
            cwd: path.dirname(filename),
            nodir: true,
            ignore: ignore
        }), filename);
    }
    return sanitizeConfig(data, null, filename);
}
exports.resolveConfigSync = resolveConfigSync;
function getGlob(data) {
    if (!Array.isArray(data.filesGlob) && Array.isArray(data.files)) {
        return [null, []];
    }
    var _a = parseGlob(data.filesGlob), glob = _a[0], ignore = _a[1];
    if (Array.isArray(data.exclude)) {
        data.exclude.forEach(function (x) { return ignore.push(x + "/**"); });
    }
    return [glob, ignore];
}
function parseGlob(filesGlob) {
    if (filesGlob === void 0) { filesGlob = []; }
    var pattern = '{**/*.ts,**/*.tsx}';
    var positives = [];
    var negatives = [];
    for (var _i = 0; _i < filesGlob.length; _i++) {
        var glob_1 = filesGlob[_i];
        if (typeof glob_1 === 'string') {
            if (glob_1.charAt(0) === '!') {
                negatives.push(glob_1.substr(1));
            }
            else {
                positives.push(glob_1);
            }
        }
    }
    if (positives.length === 1) {
        pattern = positives[0];
    }
    else if (positives.length > 1) {
        pattern = "{" + positives.join(',') + "}";
    }
    return [pattern, negatives];
}
function sanitizeConfig(data, files, filename) {
    var dirname = path.dirname(filename);
    return extend(data, {
        compilerOptions: extend(exports.DEFAULTS, data.compilerOptions),
        files: sanitizeFilenames(files || data.files, dirname),
        exclude: sanitizeFilenames(data.exclude, dirname)
    });
}
function fileExists(filename, cb) {
    fs.stat(filename, function (err, stats) {
        if (err) {
            return cb(null, false);
        }
        return cb(null, stats.isFile() || stats.isFIFO());
    });
}
function fileExistsSync(filename) {
    try {
        var stats = fs.statSync(filename);
        return stats.isFile() || stats.isFIFO();
    }
    catch (e) {
        return false;
    }
}
function sanitizeFilenames(filenames, dirname) {
    if (!filenames) {
        return [];
    }
    return filenames
        .map(function (filename) { return path.resolve(dirname, filename); })
        .filter(function (filename, index, arr) { return arr.indexOf(filename) === index; });
}
//# sourceMappingURL=tsconfig.js.map